function loadMap(e,t){void 0==t&&(t="230300");var r={title:"遮罩层",url:"http://210.77.87.225:8082/geoserver/realearth/wms",layers:"realearth:areamask",format:"image/png",ENV:"id:"+t,bkcolor:"212c48",projection:"EPSG:3857",wrapDateLine:!1,visibility:!1,numZoomLevels:20};$.ajax({url:requestUrl+"rest/getTimeline",async:!1,type:"get",dataType:"json",data:{mark:e,latestTag:"true"},success:function(e){if(e.success){var t=e.mServiceMap,a=t.extent.split(",");$("#imgUrls").attr("src",t.legend);var o=e.baseMapInfoList[0],n=!1,p=!0;void 0==o&&(n=!0,p=!1);var i=new SuperMap.Layer.WMS(t.name,t.service_url,{layers:t.layers,format:t.format,TRANSPARENT:!0},{projection:new SuperMap.Projection(t.srs),numZoomLevels:22,maxExtent:new SuperMap.Bounds(a[0],a[1],a[2],a[3]),isBaseLayer:n});if(p)var s=o.extent.split(","),u=new SuperMap.Layer.WMS(o.name,o.service_url,{layers:o.layers,format:o.format,TRANSPARENT:!0},{projection:new SuperMap.Projection(o.srs),numZoomLevels:15,maxExtent:new SuperMap.Bounds(s[0],s[1],s[2],s[3]),isBaseLayer:p});map=null,map=new SuperMap.Map({div:"map",projection:new SuperMap.Projection(t.srs),controls:[new SuperMap.Control.ScaleLine({isImperialUnits:!1}),new SuperMap.Control.Navigation]}),map.addControl(new SuperMap.Control.MousePosition({emptyString:"",displayProjection:"EPSG:4326",numDigits:2,div:document.getElementById("mouseposition")}),new SuperMap.Pixel(300,0,SuperMap.Pixel.Mode.LeftBottom)),map.addControl(new SuperMap.Control.LayerSwitcher,new SuperMap.Pixel(20,70,SuperMap.Pixel.Mode.RightTop));var c,l=[];p?(l.push(i),l.push(u),c=o.bounds.split(",")):(l.push(i),c=t.bounds.split(","),iconVector=new SuperMap.Layer.Vector("物联网",{styleMap:new SuperMap.StyleMap({})}),l.push(iconVector)),l.push(makeTDTLayerByWMTS("cia_w",!1,!1)),l.push(areaMaskLayer(r,!1)),vectors=new SuperMap.Layer.Vector("矢量图层",{styleMap:new SuperMap.StyleMap({default:new SuperMap.Style({fillColor:"#00FFFF",fillOpacity:.2,strokeColor:"#1E90FF",strokeWidth:2,strokeOpacity:.8})})}),l.push(vectors),map.addLayers(l),features&&(vectors.removeAllFeatures(),vectors.addFeatures(features)),featuresBounds?map.zoomToExtent(featuresBounds):map.zoomToExtent(new SuperMap.Bounds(c[0],c[1],c[2],c[3]))}else alert("数据暂时没有，请稍后再试!")}})}function showOrHide(){$("#showOrHide").toggle()}function transformLonLat(e,t){return new SuperMap.LonLat(e,t).transform(new SuperMap.Projection("EPSG:4326"),new SuperMap.Projection("EPSG:3857"))}function makeTDTLayerByWMTS(e,t,r,a){var o=[.703125,.3515625,.17578125,.087890625,.0439453125,.02197265625,.010986328125,.0054931640625,.00274658203125,.001373291015625,.0006866455078125,.0003433227539062,.0001716613769531,858306884766e-16,429153442383e-16,214576721191e-16,107288360596e-16,53644180298e-16,26822090149e-16,13411045074e-16,6.705522537e-7,3.352761269e-7],n=[156543.03394950466,78271.51697475233,39135.758487376166,19567.879243688083,9783.939621844042,4891.969810922021,2445.9849054610104,1222.9924527305052,611.4962263652526,305.7481131826263,152.87405659131315,76.43702829565657,38.21851414782829,19.109257073914144,9.554628536957072,4.777314268478536,2.388657134239268,1.194328567119634,.597164283559817],p={c:o.slice(0,18),w:n.slice(0,18)};e=e||"vec_c";var i="";switch(e){case"vec_c":i="街道地图_WGS84";break;case"img_c":i="影像地图_WGS84";break;case"ter_c":i="地形地图_WGS84";break;case"cva_c":i="中文标注_WGS84";break;case"eva_c":i="英文标注_WGS84";break;case"cia_c":i="影像中文标注_WGS84";break;case"eia_c":i="影像英文标注_WGS84";break;case"cta_c":i="地形中文标注_WGS84";break;case"vec_w":i="街道地图_Web墨卡托";break;case"img_w":i="影像地图_Web墨卡托";break;case"ter_w":i="地形地图_Web墨卡托";break;case"cva_w":i="中文标注_Web墨卡托";break;case"eva_w":i="英文标注_Web墨卡托";break;case"cia_w":i="影像中文标注_WGS84";break;case"eia_w":i="影像英文标注_Web墨卡托";break;case"cta_w":i="地形中文标注_Web墨卡托";break;default:e="vec_c",i="街道地图_WGS84"}for(var s=e.split("_"),u=s[0],c=s[1],l="c"==c?"EPSG:4326":"EPSG:3857",m="c"==c?"degrees":"m",d=p[c],S="c"==c?d:d.slice(1),w="c"==c?new SuperMap.LonLat(-180,90):new SuperMap.LonLat(-20037508.342787,20037508.342787),y="c"==c?new SuperMap.Bounds(-180,-90,180,90):new SuperMap.Bounds(-20037508.342787,-20037508.342787,20037508.342787,20037508.342787),M=new Array,v=1;v<19;++v)"c"==c?M[v-1]=""+v:"w"==c&&(M[v-1]=""+(v-1));return new SuperMap.Layer.WMTS({name:i,url:["http://t0.tianditu.com/"+e+"/wmts","http://t1.tianditu.com/"+e+"/wmts","http://t2.tianditu.com/"+e+"/wmts","http://t3.tianditu.com/"+e+"/wmts","http://t4.tianditu.com/"+e+"/wmts","http://t5.tianditu.com/"+e+"/wmts","http://t6.tianditu.com/"+e+"/wmts","http://t7.tianditu.com/"+e+"/wmts"],layer:u,matrixSet:c,matrixIds:M,style:"default",isBaseLayer:!!t,visibility:!!r,format:"tiles",projection:l,units:m,resolutions:d,serverResolutions:S,transitionEffect:"resize",wrapDateLine:!!a,tileSize:new SuperMap.Size(256,256),tileOrigin:w,tileFullExtent:y})}function areaMaskLayer(e,t){if(!e)return void console.log("图层参数为空，请检查！");var r=new SuperMap.Bounds(-20037508.342787,-20037508.342787,20037508.342787,20037508.342787),a=new SuperMap.Bounds(-180,-90,180,90),o="EPSG:3857"==e.projection?r:a;return e.bkcolor&&(e.ENV+=";bkcolor:"+e.bkcolor),new SuperMap.Layer.WMS(e.title||"遮罩层",e.url,{layers:e.layers,format:e.format||"image/png",ENV:e.ENV,transparent:!0},{projection:new SuperMap.Projection(e.projection),numZoomLevels:e.numZoomLevels||20,maxExtent:o,isBaseLayer:!!t,wrapDateLine:!!e.wrapDateLine,visibility:!!e.visibility})}function selectChange(e){$.ajax({url:requestUrl+"/rest/getCurOrSubAdministrationList",async:!1,type:"post",data:{adminCode:e,containGeom:"1",type:"1"},dataType:"json",success:function(e){var e=JSON.parse(e.obj);if(!e.list)return void console.log("当前行政区划信息为空");in_options={internalProjection:map.baseLayer.projection,externalProjection:new SuperMap.Projection("EPSG:3857")};var t=new SuperMap.Format.GeoJSON(in_options);if(features=t.read(e.list[0].geom)){features.constructor!=Array&&(features=[features]);for(var r=0;r<features.length;++r)featuresBounds?featuresBounds.extend(features[r].geometry.getBounds()):featuresBounds=features[r].geometry.getBounds();vectors.removeAllFeatures(),vectors.addFeatures(features),map.zoomToExtent(featuresBounds)}else console.log("error")}})}function testAddFeatures(e){var t=new SuperMap.Feature.Vector(new SuperMap.Geometry.MultiPoint([new SuperMap.Geometry.Point(14713909,5725701.66),new SuperMap.Geometry.Point(14723919,5735701.66),new SuperMap.Geometry.Point(14733929,5745701.66),new SuperMap.Geometry.Point(14743949,5755701.66),new SuperMap.Geometry.Point(14753959,5765701.66),new SuperMap.Geometry.Point(14763969,5775701.66),new SuperMap.Geometry.Point(14773979,5785701.66),new SuperMap.Geometry.Point(14783989,5795701.66)])),r=new SuperMap.Feature.Vector(new SuperMap.Geometry.MultiPoint([new SuperMap.Geometry.Point(14713909,5715701.66),new SuperMap.Geometry.Point(14723919,5715701.66),new SuperMap.Geometry.Point(14733929,5715701.66),new SuperMap.Geometry.Point(14743949,5715701.66),new SuperMap.Geometry.Point(14753959,5715701.66),new SuperMap.Geometry.Point(14763969,5715701.66),new SuperMap.Geometry.Point(14773979,5715701.66),new SuperMap.Geometry.Point(14783989,5715701.66)]));e.addFeatures([t,r])}function testAddPoints(e,t,r){var a,o={type:"MultiPoint",coordinates:[[131.84692382813,46.0986328125],[132.63793945313,46.0986328125],[132.55004882813,45.54931640625],[131.34155273438,45.87890625],[131.97875976563,46.34033203125],[130.83618164063,45.06591796875],[129.40795898438,44.75830078125],[130.11108398438,45.791015625],[130.24291992188,45.439453125],[130.06713867188,44.31884765625],[130.06713867188,44.31884765625],[131.84692382813,46.0986328125]]},n={type:"MultiPoint",coordinates:[[14704038.255116524,5712785.729449741],[14720548.653224103,5697946.434445069],[14666125.489092913,5671819.322922272],[14592134.445723439,5684873.35286638],[14664291.000414044,5712785.729449741],[14689973.841914844,5737280.819282453],[14633104.692877753,5740785.6191607285],[14718714.164545234,5732901.757797374],[14637385.166461406,5665733.938981488],[14609867.836282851,5710165.2391039],[14611090.828734687,5717154.922915243],[14631270.2042,5734653.1241179295],[14704038.255116524,5712785.729449741]]},p=new SuperMap.Format.GeoJSON(in_options);"EPSG:4326"==t?(a=p.read(o),a[0].geometry=a[0].geometry.transform(new SuperMap.Projection("EPSG:4326"),new SuperMap.Projection("EPSG:3857"))):a=p.read(n),a&&(a.constructor!=Array&&(a=[a]),e.removeAllFeatures(),e.addFeatures(a))}function iconVectorEquipment(e){var t=[];$.ajax({url:"http://www.woappstore.com/portal/region/listEquipmentByCode",async:!1,type:"post",dataType:"json",data:{code:adminCode},success:function(e){if(console.log(e),0==e.ret){for(var r=e.IoTDevice,a=0,o=r.length;a<o;a++){var n=new SuperMap.Geometry.Point(r[a].longitude,r[a].latitude);n=n.transform(new SuperMap.Projection("EPSG:4326"),new SuperMap.Projection("EPSG:3857"));var p=new SuperMap.Feature.Vector(n,r[a],{externalGraphic:"/agri-rs-web/img/wulianwang.png",graphicZIndex:1e6,pointRadius:10});t.push(p)}for(var i=e.videoDevice,a=0,o=e.videoDevice.length;a<o;a++){var n=new SuperMap.Geometry.Point(i[a].longitude,i[a].latitude);n=n.transform(new SuperMap.Projection("EPSG:4326"),new SuperMap.Projection("EPSG:3857"));var p=new SuperMap.Feature.Vector(n,i[a],{externalGraphic:"/agri-rs-web/img/shexiangtou.png",graphicZIndex:1e6,pointRadius:10});t.push(p)}}else console.log("物联网接口请求错误")}});var r=new SuperMap.Control.SelectFeature([e],{clickout:!0,toggle:!1,multiple:!1,hover:!1,toggleKey:"ctrlKey",multipleKey:"shiftKey"});map.addControl(r),e.addFeatures(t),r.activate(),e.events.on({featureselected:function(e){console.log(e),popup&&map.removePopup(popup)&&popup.destroy()&&(popup=void 0);var t=e.evt.xy.x,r=e.evt.xy.y,a=e.feature;console.log("data="+a.attributes);var o="<br><table><tbody>",n="";for(var p in a.attributes)"region_name"==p&&(o+="<tr><td style='text-align:regiht;color:#0edcd8'>区域:</td><td style='text-align:left;color:#0edcd8'>"+a.attributes[p]+"</td></tr>"),"data_block_name"==p&&(o+="<tr><td style='text-align:regiht;color:#0edcd8'>地块名:</td><td style='text-align:left;color:#0edcd8'>"+a.attributes[p]+"</td></tr>"),"data_block_name"!=p&&"equipment_code"!=p&&"ip"!=p&&"http_port"!=p&&"username"!=p&&"password"!=p&&"channel"!=p&&"equipment_type"!=p||(n+=a.attributes[p]+",");o+="<tr><td colspan='2' style='text-align:right;'><a style='color:#032064;' href='#' onclick='selectedInfos(\""+n+"\");' class=''>查看详情</a></td></tr>",o+="</tbody><table>",popup=new SuperMap.Popup.FramedCloud("信息",map.getLonLatFromPixel({x:t,y:r}),new SuperMap.Size(100,100),o,null,!0,function(){map.removePopup(popup)&&popup.destroy()&&(popup=void 0)}),map.addPopup(popup)}})}function selectedInfos(e){console.log("param="+e);var t,r,a,o,n,p,i,s,u=e.split(",");t=u[0],r=u[1],s=u[2],a=u[3],o=u[4],n=u[5],p=u[6],i=u[7],"0"==a&&(window.location.href="infor.html?equipment_code="+t+"&data_block_name="+s),"1"==a&&(window.location.href="video.html?channel="+r+"&password="+o+"&ip="+n+"&http_port="+p+"&username="+i)}var map,vectors,features,featuresBounds,iconVector,popup;